



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="迩彧博客" href="https://muxiaoximuxiaoxi.github.io/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="迩彧博客" href="https://muxiaoximuxiaoxi.github.io/atom.xml" />
<link rel="alternate" type="application/json" title="迩彧博客" href="https://muxiaoximuxiaoxi.github.io/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="https://muxiaoximuxiaoxi.github.io/2024/04/28/HDI-GEN%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AF%BC/">



  <title>
HDI-GEN使用指导 - _驱动子系统 |
Yume Shoka = 迩彧博客</title>
<meta name="generator" content="Hexo 6.0.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">HDI-GEN使用指导
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-04-28 21:04:32">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-04-28T21:04:32+08:00">2024-04-28</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicmnywqgpj20zk0m8dwx.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclh5u05ej20zk0m87df.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipexj2jgzj20zk0m8b09.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicis081o9j20zk0m8dmr.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclh3brzpj20zk0m8ann.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4baakhj20zk0m8h5q.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E9%A9%B1%E5%8A%A8%E5%AD%90%E7%B3%BB%E7%BB%9F/" itemprop="item" rel="index" title="In _驱动子系统"><span itemprop="name">_驱动子系统</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="https://muxiaoximuxiaoxi.github.io/2024/04/28/HDI-GEN%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AF%BC/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="迩彧">
    <meta itemprop="description" content=", 与其临渊羡鱼，不如退而结网">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="迩彧博客">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p>HDI-GEN使用手册</p>
<ul>
<li><a href="#HDI-GEN%E7%AE%80%E4%BB%8B">HDI-GEN简介</a></li>
<li><a href="#IDL%E6%8E%A5%E5%8F%A3">IDL接口</a><ul>
<li><a href="#IDL%E7%AE%80%E4%BB%8B">IDL简介</a></li>
<li><a href="#IDL%E6%9E%84%E6%88%90">IDL构成</a></li>
<li><a href="#IDL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">IDL数据类型</a><ul>
<li><a href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">基本数据类型</a></li>
<li><a href="#%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B">容器类型</a></li>
<li><a href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">自定义数据类型</a></li>
<li><a href="#callback%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B">callback数据类型</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#HDI-GEN%E4%BD%BF%E7%94%A8">HDI-GEN使用</a><ul>
<li><a href="#%E6%BA%90%E7%A0%81%E8%8E%B7%E5%8F%96">源码获取</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E7%BC%96%E8%AF%91">工具编译</a></li>
<li><a href="#%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8">工具使用</a></li>
<li><a href="#%E5%A4%9AIDL%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90">多IDL文件生成</a></li>
<li><a href="#%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81">生成代码</a></li>
<li><a href="#%E5%BC%80%E5%8F%91%E7%A4%BA%E4%BE%8B">开发示例</a></li>
</ul>
</li>
<li><a href="#HDI%E9%9B%86%E6%88%90">HDI集成</a></li>
</ul>
<h2 id="HDI-GEN简介"><a href="#HDI-GEN简介" class="headerlink" title="HDI-GEN简介"></a>HDI-GEN简介</h2><p>​        HDI-GEN(Hardware Driver Interface-Generator)属于HDF开发套件的一部分，是在编译阶段将将接口描述文件(.idl)转换成可编译执行的C&#x2F;C++目标源码，并实现接口代理端和服务端的工具。</p>
<h2 id="IDL接口"><a href="#IDL接口" class="headerlink" title="IDL接口"></a>IDL接口</h2><h3 id="IDL简介"><a href="#IDL简介" class="headerlink" title="IDL简介"></a>IDL简介</h3><p>​        当客户端与服务器通信时，需要定义双方都认可的接口，以保障双方可以成功通信。HarmonyOs IDL(Interface Definition Language) 则是一种定义此类接口的语言。</p>
<p>​        HarmonyOS IDL先把需要传递的对象分解成操作系统能够理解的基本类型，并根据开发者的需要封装跨边界的对象。在HarmonyOS中，HarmonyOS IDL接口包含面向应用程序的北向接口和面向硬件设备的南向接口。</p>
<p>HarmonyOs IDL接口描述语言主要用于：</p>
<ul>
<li>声明系统服务对外提供的服务接口，根据接口声明在编译时生成跨进程调用（IPC）或跨设备调用（RPC）的代理（Proxy）和桩（Stub）的C&#x2F;C++代码。</li>
<li>声明Ability对外提供的服务接口，根据接口声明在编译时生成跨进程调用（IPC）或跨设备调用（RPC）的代理（Proxy）和桩（Stub）的C&#x2F;C++代码。</li>
</ul>
<p>使用HarmonyOS IDL接口描述语言声明接口具有以下优点：</p>
<ul>
<li>HarmonyOS IDL中是以接口的形式定义服务，可以专注于定义而隐藏实现细节。</li>
<li>HarmonyOS IDL中定义的接口可以支持跨进程调用或跨设备调用。根据HarmonyOS IDL中的定义生成的信息或代码可以简化跨进程或跨设备调用接口的实现。</li>
</ul>
<h3 id="IDL构成"><a href="#IDL构成" class="headerlink" title="IDL构成"></a>IDL构成</h3><p>IDL 描述的接口代码示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;  //包名</span><br><span class="line"></span><br><span class="line">import foo.v1_0.IFooCallback;  //导入对应路径下的IFooCallback.idl</span><br><span class="line">import foo.v1_0.MyTypes;</span><br><span class="line"></span><br><span class="line">sequenceable foo.v1_0.IFooAbilityInfo;</span><br><span class="line"></span><br><span class="line">interface IFoo &#123;    //接口定义</span><br><span class="line">    Ping([in] String sendMsg, [out] String recvMsg);</span><br><span class="line">    GetData([out] struct FooInfo info);</span><br><span class="line">    SendCallbackObj([in] IFooCallback cbObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明：</p>
<ul>
<li><p>IDL接口描述文件使用C注释。</p>
</li>
<li><p>IDL接口描述文件是以”*.idl”为扩展名的文件。</p>
</li>
<li><p>IDL接口描述文件目录层级必须严格按照包名的层次进行定义，例如：IFoo.idl中的”package foo.v1_0;“对应foo&#x2F;v1_0&#x2F;IFoo.idl</p>
</li>
<li><p>“import foo.v1_0.IFooCallback;”表示IFoo.idl导入foo&#x2F;v1_0&#x2F;IFooCallback.idl文件。并可以使用IFooCallback.idl文件中定义的类型。</p>
</li>
<li><p>“sequenceable foo.v1_0.IFooAbilityInfo;”表示导入一种可序列化的类IFooAbilityInfo，开发者需手动提供该类的C++文件。</p>
</li>
<li><p>IDL接口描述文件主要以类名命名，例如：IFoo.idl中接口类名为IFoo，特殊的MyTypes.idl则为自定义类型数据的IDL文件。</p>
</li>
<li><p>接口声明无需返回值。</p>
</li>
<li><p>“[in]”、”[out]”表示参数为输入参数还是输出参数。</p>
</li>
</ul>
<h3 id="IDL数据类型"><a href="#IDL数据类型" class="headerlink" title="IDL数据类型"></a>IDL数据类型</h3><p>HarmonyOS IDL支持的数据类型可分为：<a href="#">基本数据类型</a>、<a href="#">自定义数据类型</a>、声明的<a href="#">Sequenceable数据类型</a>、<a href="#">数组类型</a>、<a href="#">容器类型</a>、<a href="#">callback类型</a>。</p>
<ul>
<li><h5 id="基本数据类型"><a href="#基本数据类型" class="headerlink" title="基本数据类型"></a>基本数据类型</h5><p>IDL基本数据类型与C&#x2F;C++数据类型的对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th>IDL基本数据类型</th>
<th>C++数据类型</th>
<th>C数据类型</th>
<th>数据长度(bytes)</th>
</tr>
</thead>
<tbody><tr>
<td>boolean</td>
<td>bool</td>
<td>bool</td>
<td>1</td>
</tr>
<tr>
<td>byte</td>
<td>int8_t</td>
<td>int8_t</td>
<td>1</td>
</tr>
<tr>
<td>short</td>
<td>int16_t</td>
<td>int16_t</td>
<td>2</td>
</tr>
<tr>
<td>int</td>
<td>int32_t</td>
<td>int32_t</td>
<td>4</td>
</tr>
<tr>
<td>long</td>
<td>int64_t</td>
<td>int64_t</td>
<td>8</td>
</tr>
<tr>
<td>float</td>
<td>float</td>
<td>float</td>
<td>4</td>
</tr>
<tr>
<td>double</td>
<td>double</td>
<td>double</td>
<td>8</td>
</tr>
<tr>
<td>String</td>
<td>std::string</td>
<td>cstring</td>
<td>NA</td>
</tr>
<tr>
<td>unsigned char</td>
<td>uint8_t</td>
<td>uint8_t</td>
<td>1</td>
</tr>
<tr>
<td>unsigned short</td>
<td>uint16_t</td>
<td>uint16_t</td>
<td>2</td>
</tr>
<tr>
<td>unsigned int</td>
<td>uint32_t</td>
<td>uint32_t</td>
<td>4</td>
</tr>
<tr>
<td>unsigned long</td>
<td>uint64_t</td>
<td>uint64_t</td>
<td>8</td>
</tr>
</tbody></table>
</li>
<li><h5 id="自定义类型"><a href="#自定义类型" class="headerlink" title="自定义类型"></a>自定义类型</h5><p>自定义类型是指使用关键字struct、union、enum定义的结构体类型、联合体类型、枚举类型，以及这些类型组合嵌套定义的类型。自定义类型文件MyTypes.idl示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">struct Example1 &#123;</span><br><span class="line">    String member1;</span><br><span class="line">    unsigned int member2;</span><br><span class="line">    String[] member3;</span><br><span class="line">    Map&lt;int, String&gt; member4;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">union Example2 &#123;</span><br><span class="line">    String member1;</span><br><span class="line">    unsigned int member2;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">enum Example3 : int &#123;</span><br><span class="line">    RED = 1,</span><br><span class="line">    BLUE,</span><br><span class="line">    GREEN,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct Example1_2_3 &#123;</span><br><span class="line">    struct Example1;</span><br><span class="line">    union Example2;</span><br><span class="line">    enum Example3;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>在定义枚举类型时，需要指定枚举类型的基本数据类型，可以使用byte、short、int、long、unsigned char、unsigned short、unsigned int、unsigned long。如果未指定，则默认基础类型为int类型。</p>
<p>注意：</p>
<ul>
<li>自定义类型数据尚不支持typedef功能，使用时需要添加对应的struct、union、enum前缀。</li>
</ul>
<p>一个模块在定义IDL接口时使用的自定义类型应该定义在一个独立的文件中，不要分散到每个接口定义的文件中。自定义类型所在文件的名称可以根据实际情况进行定义，在接口定义文件中需要导入自定义类型文件，例如：MyInterface.idl接口使用了MyTypes.idl中定义的自定义类型，代码示例如下。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import ohos.module.MyTypes;</span><br><span class="line"></span><br><span class="line">interface ohos.module.MyInterface &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IDL自定义数据类型与C&#x2F;C++数据类型的对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th>自定义数据类型</th>
<th>C++数据类型</th>
<th>C数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>struct</td>
<td>struct</td>
<td>struct</td>
</tr>
<tr>
<td>union</td>
<td>union</td>
<td>union</td>
</tr>
<tr>
<td>enum</td>
<td>enum</td>
<td>enum</td>
</tr>
</tbody></table>
</li>
</ul>
<p>​        </p>
<ul>
<li><h5 id="Sequenceable数据类型"><a href="#Sequenceable数据类型" class="headerlink" title="Sequenceable数据类型"></a>Sequenceable数据类型</h5><p>Sequenceable数据类型是指用“Sequenceable”关键字声明的非数据类型，表明该数据可通过Parcel进行夸进程（跨设备）传递。声明形式为“sequenceable namespace.typename;”，namespace是该类型所属的命名空间，内部采用“.”连接不同层级的命名空间，typename是类型名。例如：“sequenceable com.huawei.samples.ApplicationInfo;”</p>
<p>Sequenceable数据类型并不在IDL文件中定义，而是定义在C++文件中，C语言文件不支持。因此，HDI-GEN工具将根据其声明在生成的C++代码文件中加入“#include “com&#x2F;huawei&#x2F;samples&#x2F;ApplicationInfo.h””语句。</p>
<p>IDL Sequenceable数据类型与C&#x2F;C++数据类型的对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th>IDL Sequenceable数据类型</th>
<th>C++数据类型</th>
<th>C数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>Sequenceable namespace.typename</td>
<td>class typename : public Parcelable</td>
<td>不支持</td>
</tr>
</tbody></table>
</li>
<li><h5 id="数组类型"><a href="#数组类型" class="headerlink" title="数组类型"></a>数组类型</h5><p>数组类型用“T[]”表示，T可以是基本数据类型、自定义类型、Sequenceable数据类型、接口类型和数组类型。</p>
<p>在C++代码中，数组类型生成为std::vector&lt;T&gt;。</p>
<p>HarmonyOS IDL数组数据类型与C&#x2F;C++数据类型的对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th>IDL数据类型</th>
<th>C++数据类型</th>
<th>C数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>T[]</td>
<td>std::vector&lt;T&gt;</td>
<td>T*,int size</td>
</tr>
</tbody></table>
</li>
<li><h5 id="容器类型"><a href="#容器类型" class="headerlink" title="容器类型"></a>容器类型</h5><p>当前支持两种容器：List和Map。List容器用法为“List&lt;T&gt;”， Map容器用法为“Map&lt;KT, VT&gt;”，T、KT和VT可以为基本数据类型、自定义类型、Sequenceable类型、接口类型、数组类型或容器类型。</p>
<p>在C++代码中，List容器类型生成为std::list，Map容器类型生成为std::map。</p>
<p>IDL容器数据类型与C&#x2F;C++数据类型的对应关系如下表所示：</p>
<table>
<thead>
<tr>
<th>HarmonyOS IDL数据类型</th>
<th>C++数据类型</th>
<th>C数据类型</th>
</tr>
</thead>
<tbody><tr>
<td>List&lt;T&gt;</td>
<td>std::vector&lt;T&gt;</td>
<td>T*,int size</td>
</tr>
<tr>
<td>Map&lt;KT, VT&gt;</td>
<td>std::map&lt;KT, VT&gt;</td>
<td>不支持</td>
</tr>
</tbody></table>
</li>
<li><h5 id="callback数据类型"><a href="#callback数据类型" class="headerlink" title="callback数据类型"></a>callback数据类型</h5><p>当IDL文件中的接口添加[callback]属性时，即可成为可传输的接口类型。示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">[callback] interface IFooCallback &#123;</span><br><span class="line">    PushData([in] String message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>callback接口数据类型可作为参数进行传输，示例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">import foo.v1_0.IFooCallback;</span><br><span class="line"></span><br><span class="line">interface IFoo &#123;</span><br><span class="line">    SendCallbackObj([in] IFooCallback cbObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p>​        callback标识了一个接口生成client，server代码，一端构造callback服务对象，发送至另一端后转换为callback客户端对象，即可通过callback客户端对象主动发送数据，即可实现下层实现中回调到上层服务中。</p>
<h2 id="HDI-GEN使用"><a href="#HDI-GEN使用" class="headerlink" title="HDI-GEN使用"></a>HDI-GEN使用</h2><h3 id="源码获取"><a href="#源码获取" class="headerlink" title="源码获取"></a>源码获取</h3><p>hdi-gen工具源码在OpenHarmonyOs项目如下路径中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//drivers/framework/tools/hdi-gen</span><br></pre></td></tr></table></figure>

<h3 id="工具编译"><a href="#工具编译" class="headerlink" title="工具编译"></a>工具编译</h3><p>hdi-gen工具使用make构建，在Windows下需安装MinGW-64环境。</p>
<h3 id="工具使用"><a href="#工具使用" class="headerlink" title="工具使用"></a>工具使用</h3><p>查看命令参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen --help</span><br><span class="line">Compile a .idl file and generate C/C++ and Java codes.</span><br><span class="line">Usage: idl [options] file</span><br><span class="line">Options:</span><br><span class="line">  --help                          Display command line options</span><br><span class="line">  --version                       Display toolchain version information</span><br><span class="line">  --dump-ast                      Display the AST of the compiled file</span><br><span class="line">  -c &lt;*.idl&gt;                      Compile the .idl file</span><br><span class="line">  --gen-hash                      Generate hash key of the idl file</span><br><span class="line">  --gen-c                         Generate C code</span><br><span class="line">  --gen-cpp                       Generate C++ code</span><br><span class="line">  --gen-java                      Generate Java code</span><br><span class="line">  --kernel                        Generate kernel-mode ioservice stub code, default user-mode ioservice stub code</span><br><span class="line">  --module-name &lt;module name&gt;     Set driver module name</span><br><span class="line">  --build-target &lt;target name&gt;    Generate client code, server code or all code</span><br><span class="line">  -d &lt;directory&gt;                  Place generated codes into &lt;directory&gt;</span><br></pre></td></tr></table></figure>

<p>查看版本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen --version</span><br><span class="line"></span><br><span class="line">HDI-GEN: 0.1</span><br><span class="line">Copyright (c) Huawei Technologies Co., Ltd. 2021-2021. All rights reserved.</span><br></pre></td></tr></table></figure>

<p>查看IDL文件哈希值</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./ohos/../../../IFoo.idl --<span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">~/OpenHarmony/drivers/framework/tools/hdi-gen/ohos/../../../IFoo.idl:3921859865297561794</span><br></pre></td></tr></table></figure>

<p>生成用户态驱动C代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-c -d ./out</span><br></pre></td></tr></table></figure>

<p>生成用户态驱动C客户端代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-c --build-target client -d ./out</span><br></pre></td></tr></table></figure>

<p>生成内核态驱动C代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-c --kernel -d ./out</span><br></pre></td></tr></table></figure>

<p>指定驱动module name</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-c --module-name foo_service -d ./out</span><br></pre></td></tr></table></figure>

<p>生成用户态驱动C++代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-cpp -d ./out</span><br></pre></td></tr></table></figure>



<h3 id="多IDL文件生成"><a href="#多IDL文件生成" class="headerlink" title="多IDL文件生成"></a>多IDL文件生成</h3><p>给出以下IDL文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ tree ./foo/</span><br><span class="line">./foo/</span><br><span class="line">└── v1_0</span><br><span class="line">    ├── IFooCallback.idl</span><br><span class="line">    ├── IFoo.idl</span><br><span class="line">    └── MyTypes.idl</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>IFoo.idl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">import foo.v1_0.IFooCallback;</span><br><span class="line">import foo.v1_0.MyTypes;</span><br><span class="line"></span><br><span class="line">interface IFoo &#123;</span><br><span class="line">    Ping([in] String sendMsg, [out] String recvMsg);</span><br><span class="line">    GetData([out] struct FooInfo info);</span><br><span class="line">    SendCallbackObj([in] IFooCallback cbObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IFooCallback.idl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">[callback] interface IFooCallback &#123;</span><br><span class="line">    PushData([in] String message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyTypes.idl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">enum FooType &#123;</span><br><span class="line">    FOO_TYPE_ONE = 1,</span><br><span class="line">    FOO_TYPE_TWO,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct FooInfo &#123;</span><br><span class="line">    unsigned int id_;</span><br><span class="line">    String name_;</span><br><span class="line">    enum FooType type_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>生成C++代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-cpp -d ./out</span><br></pre></td></tr></table></figure>

<p>这里只指定IFoo.idl，hdi-gen工具会读取IFoo.idl中的import信息，并根据其路径找到其他包含的idl文件。当然亦可手动指定所有idl文件，如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hdi-gen -c ./foo/v1_0/IFoo.idl -c ./foo/v1_0/IFooCallback.idl -c ./foo/v1_0/MyTypes.idl --gen-cpp -d ./out</span><br></pre></td></tr></table></figure>

<p>生成代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tree</span> ./out</span><br><span class="line">./out</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── foo_callback_proxy.cpp</span><br><span class="line">        ├── foo_callback_proxy.h</span><br><span class="line">        ├── foo_callback_service.cpp</span><br><span class="line">        ├── foo_callback_service.h</span><br><span class="line">        ├── foo_callback_stub.cpp</span><br><span class="line">        ├── foo_callback_stub.h</span><br><span class="line">        ├── foo_driver.cpp</span><br><span class="line">        ├── foo_proxy.cpp</span><br><span class="line">        ├── foo_proxy.h</span><br><span class="line">        ├── foo_service.cpp</span><br><span class="line">        ├── foo_service.h</span><br><span class="line">        ├── foo_stub.cpp</span><br><span class="line">        ├── foo_stub.h</span><br><span class="line">        ├── ifoo_callback.h</span><br><span class="line">        ├── ifoo.h</span><br><span class="line">        ├── my_types.cpp</span><br><span class="line">        └── my_types.h</span><br></pre></td></tr></table></figure>



<h3 id="生成代码"><a href="#生成代码" class="headerlink" title="生成代码"></a>生成代码</h3><p>IDL按功能分为三类：用于定义接口的IDL，回调功能的IDL，自定义数据类型IDL。</p>
<ul>
<li><h4 id="接口定义的IDL"><a href="#接口定义的IDL" class="headerlink" title="接口定义的IDL"></a>接口定义的IDL</h4><p>现提供以下IDL文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ tree ./foo</span><br><span class="line">./foo</span><br><span class="line">└── v1_0</span><br><span class="line">    └── IFoo.idl</span><br></pre></td></tr></table></figure>

<p>IFoo.idl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> package foo.v1_0;</span><br><span class="line"></span><br><span class="line">interface IFoo &#123;</span><br><span class="line">    Ping([in] String sendMsg, [out] String recvMsg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成C++代码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hdi-gen -c ./foo/v1_0/IFoo.idl --gen-cpp -d ./out</span><br></pre></td></tr></table></figure>

<p>C++代码如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ tree ./out</span><br><span class="line">./out</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── foo_driver.cpp    // 驱动入口文件</span><br><span class="line">        ├── foo_proxy.cpp</span><br><span class="line">        ├── foo_proxy.h       // 客户端代理类定义</span><br><span class="line">        ├── foo_service.cpp</span><br><span class="line">        ├── foo_service.h     // 服务端接口实现类定义</span><br><span class="line">        ├── foo_stub.cpp</span><br><span class="line">        ├── foo_stub.h        // 服务端桩类定义</span><br><span class="line">        └── ifoo.h            // 接口类定义</span><br></pre></td></tr></table></figure>

<p>ifoo.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_IFOO_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_IFOO_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iremote_broker.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_PING,  <span class="comment">//调用编号</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __HDI_SERVER__  <span class="comment">// server端代码编译需开启此宏</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IFoo</span> : <span class="keyword">public</span> IRemoteBroker &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DECLARE_INTERFACE_DESCRIPTOR</span>(<span class="string">u&quot;foo.v1_0.IFoo&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> sptr&lt;IFoo&gt; <span class="title">Get</span><span class="params">()</span></span>;    <span class="comment">// 获取客户端实例接口</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">static</span> sptr&lt;IFoo&gt; <span class="title">GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; serviceName)</span></span>;  <span class="comment">// 获取客户端实例接口</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IFoo</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">IFoo</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span> </span>= <span class="number">0</span>;  <span class="comment">//接口声明</span></span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_IFOO_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_proxy.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOPROXY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOPROXY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iremote_proxy.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooProxy</span> : <span class="keyword">public</span> IRemoteProxy&lt;IFoo&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">FooProxy</span><span class="params">(<span class="type">const</span> sptr&lt;IRemoteObject&gt;&amp; remote)</span> : IRemoteProxy&lt;IFoo&gt;(remote) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooProxy</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span> <span class="keyword">override</span></span>;  <span class="comment">//对接口进行重写</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="keyword">inline</span> BrokerDelegator&lt;FooProxy&gt; delegator_;</span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOPROXY_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_proxy.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_proxy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iservmgr_hdi.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_option.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_parcel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function">sptr&lt;IFoo&gt; <span class="title">IFoo::Get</span><span class="params">()</span>  <span class="comment">// 获取客户端实例，默认连接名为&quot;foo_service&quot;的服务端</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> IFoo::<span class="built_in">GetInstance</span>(<span class="string">&quot;foo_service&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">sptr&lt;IFoo&gt; <span class="title">IFoo::GetInstance</span><span class="params">(<span class="type">const</span> std::string&amp; serviceName)</span>  <span class="comment">// 获取客户端实例，手动指定要连接的服务名</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">using</span> <span class="keyword">namespace</span> OHOS::HDI::ServiceManager::V1_0;</span><br><span class="line">        <span class="keyword">auto</span> servMgr = IServiceManager::<span class="built_in">Get</span>();</span><br><span class="line">        <span class="keyword">if</span> (servMgr == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s:get IServiceManager failed!&quot;</span>, __func__);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sptr&lt;IRemoteObject&gt; remote = servMgr-&gt;<span class="built_in">GetService</span>(serviceName.<span class="built_in">c_str</span>());</span><br><span class="line">        <span class="keyword">if</span> (remote != <span class="literal">nullptr</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> iface_cast&lt;IFoo&gt;(remote);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: get foo_service failed!&quot;</span>, __func__);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooProxy::Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span>  <span class="comment">//代理类对接口的重写</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MessageParcel data_;  <span class="comment">// 用于序列化的buf</span></span><br><span class="line">    MessageParcel reply_; <span class="comment">// 用于反序列化的buf</span></span><br><span class="line">    <span class="function">MessageOption <span class="title">option_</span><span class="params">(MessageOption::TF_SYNC)</span></span>;  <span class="comment">//调用方式，默认为同步调用</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 参数序列化</span></span><br><span class="line">    <span class="keyword">if</span> (!data_.<span class="built_in">WriteString</span>(sendMsg)) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write sendMsg failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_ERR_INVALID_PARAM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 发送数据</span></span><br><span class="line">    <span class="type">int32_t</span> ec = <span class="built_in">Remote</span>()-&gt;<span class="built_in">SendRequest</span>(CMD_PING, data_, reply_, option_);</span><br><span class="line">    <span class="keyword">if</span> (ec != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s failed, error code is %&#123;public&#125;d&quot;</span>, __func__, ec);</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 参数反序列化</span></span><br><span class="line">    recvMsg = reply_.<span class="built_in">ReadString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure>

<p>foo_driver.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osal_mem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_device_desc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_stub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HdfFooHost</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">IDeviceIoService</span> ioservice;</span><br><span class="line">    <span class="type">void</span> *instance;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息接收入口</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int32_t</span> <span class="title">FooDriverDispatch</span><span class="params">(<span class="keyword">struct</span> HdfDeviceIoClient *client, <span class="type">int</span> cmdId,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">struct</span> HdfSBuf *data, <span class="keyword">struct</span> HdfSBuf *reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">HdfFooHost</span> *hdfFooHost = <span class="built_in">CONTAINER_OF</span>(</span><br><span class="line">        client-&gt;device-&gt;service, <span class="keyword">struct</span> HdfFooHost, ioservice);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">FooServiceOnRemoteRequest</span>(hdfFooHost-&gt;instance, cmdId, data, reply);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">HdfFooDriverInit</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *deviceObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HDF_LOGI</span>(<span class="string">&quot;HdfFooDriverInit enter&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">HdfFooDriverBind</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *deviceObject)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">HDF_LOGI</span>(<span class="string">&quot;HdfFooDriverBind enter&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">HdfFooHost</span> *hdfFooHost = (<span class="keyword">struct</span> HdfFooHost *)<span class="built_in">OsalMemAlloc</span>(</span><br><span class="line">        <span class="built_in">sizeof</span>(<span class="keyword">struct</span> HdfFooHost));</span><br><span class="line">    <span class="keyword">if</span> (hdfFooHost == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;HdfFooDriverBind OsalMemAlloc HdfFooHost failed!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> HDF_FAILURE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    hdfFooHost-&gt;ioservice.Dispatch = FooDriverDispatch;</span><br><span class="line">    hdfFooHost-&gt;ioservice.Open = <span class="literal">NULL</span>;</span><br><span class="line">    hdfFooHost-&gt;ioservice.Release = <span class="literal">NULL</span>;</span><br><span class="line">    hdfFooHost-&gt;instance = <span class="built_in">FooStubInstance</span>(); <span class="comment">// 获取stub类</span></span><br><span class="line"></span><br><span class="line">    deviceObject-&gt;service = &amp;hdfFooHost-&gt;ioservice;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">HdfFooDriverRelease</span><span class="params">(<span class="keyword">struct</span> HdfDeviceObject *deviceObject)</span></span>&#123;</span><br><span class="line">    <span class="built_in">HDF_LOGI</span>(<span class="string">&quot;HdfFooDriverRelease enter&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">HdfFooHost</span> *hdfFooHost = <span class="built_in">CONTAINER_OF</span>(deviceObject-&gt;service, <span class="keyword">struct</span> HdfFooHost, ioservice);</span><br><span class="line">    <span class="built_in">FooStubRelease</span>(hdfFooHost-&gt;instance);</span><br><span class="line">    <span class="built_in">OsalMemFree</span>(hdfFooHost);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">HdfDriverEntry</span> g_fooDriverEntry = &#123;</span><br><span class="line">    .moduleVersion = <span class="number">1</span>,</span><br><span class="line">    .moduleName = <span class="string">&quot;sample&quot;</span>,  <span class="comment">//moduleName可根据hdi-gen的命令参数--module-name指定，默认为sample</span></span><br><span class="line">    .Bind = HdfFooDriverBind,</span><br><span class="line">    .Init = HdfFooDriverInit,</span><br><span class="line">    .Release = HdfFooDriverRelease,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="built_in">HDF_INIT</span>(g_fooDriverEntry);</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>foo_stub.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOSTUB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOSTUB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_option.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_parcel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooStub</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooStub</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">FooStubPing</span><span class="params">(MessageParcel&amp; data_, MessageParcel&amp; reply_, MessageOption&amp; option_)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">FooStubOnRemoteRequest</span><span class="params">(<span class="type">int</span> cmdId, MessageParcel&amp; data, MessageParcel&amp; reply,</span></span></span><br><span class="line"><span class="params"><span class="function">        MessageOption&amp; option)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *dlHandler;  <span class="comment">// 存储连接服务实现库的句柄</span></span><br><span class="line">    IFoo *service;    <span class="comment">// 指向接口实现类</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">FooStubInstance</span><span class="params">()</span></span>;  <span class="comment">// 获取stub实例</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooStubRelease</span><span class="params">(<span class="type">void</span> *obj)</span></span>;  <span class="comment">// 释放stub实例</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooServiceOnRemoteRequest</span><span class="params">(<span class="type">void</span> *stub, <span class="type">int</span> cmdId, <span class="keyword">struct</span> HdfSBuf* data, <span class="keyword">struct</span> HdfSBuf* reply)</span></span>;  <span class="comment">// 消息入口</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOSTUB_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_stub.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_stub.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_sbuf_ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;securec.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __ARM64__</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRIVER_PATH <span class="string">&quot;system/lib64&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DRIVER_PATH <span class="string">&quot;system/lib&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> foo::v1_0::IFoo* (*SERVICE_CONSTRUCT_FUNC)();</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*SERVICE_RELEASE_FUNC)</span><span class="params">(foo::v1_0::IFoo *obj)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息分发</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooStub::FooStubOnRemoteRequest</span><span class="params">(<span class="type">int</span> cmdId,</span></span></span><br><span class="line"><span class="params"><span class="function">    MessageParcel&amp; data, MessageParcel&amp; reply, MessageOption&amp; option)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (cmdId) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_PING:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">FooStubPing</span>(data, reply, option);</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: not support cmd %&#123;public&#125;d&quot;</span>, __func__, cmdId);</span><br><span class="line">            <span class="keyword">return</span> HDF_ERR_INVALID_PARAM;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行参数的反序列化与序列化工作</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooStub::FooStubPing</span><span class="params">(MessageParcel&amp; data_, MessageParcel&amp; reply_, MessageOption&amp; option_)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string sendMsg = data_.<span class="built_in">ReadString</span>();  <span class="comment">// 参数反序列化</span></span><br><span class="line"></span><br><span class="line">    std::string recvMsg;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> ec = service-&gt;<span class="built_in">Ping</span>(sendMsg, recvMsg);  <span class="comment">// 调用实现类接口</span></span><br><span class="line">    <span class="keyword">if</span> (ec != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s failed, error code is %d&quot;</span>, __func__, ec);</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!reply_.<span class="built_in">WriteString</span>(recvMsg)) &#123;  <span class="comment">// 参数序列化</span></span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write recvMsg failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_ERR_INVALID_PARAM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//用于连接接口实现库</span></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> *<span class="title">LoadServiceHandler</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* libFileName)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> path[PATH_MAX + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">char</span> libPath[PATH_MAX + <span class="number">1</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">void</span> *handler = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">snprintf_s</span>(path, <span class="built_in">sizeof</span>(path), <span class="built_in">sizeof</span>(path) - <span class="number">1</span>, <span class="string">&quot;%s/%s&quot;</span>, DRIVER_PATH, libFileName) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: snprintf_s failed&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">realpath</span>(path, libPath) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s file name invalid&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    handler = <span class="built_in">dlopen</span>(libPath, RTLD_LAZY);</span><br><span class="line">    <span class="keyword">if</span> (handler == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: dlopen failed %&#123;public&#125;s&quot;</span>, __func__, <span class="built_in">dlerror</span>());</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> handler;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取桩类实例</span></span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">FooStubInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line">    SERVICE_CONSTRUCT_FUNC serviceConstructFunc = <span class="literal">nullptr</span>;</span><br><span class="line">    FooStub *stub = <span class="keyword">new</span> <span class="built_in">FooStub</span>();</span><br><span class="line">    <span class="keyword">if</span> (stub == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: OsalMemAlloc stub failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stub-&gt;dlHandler = <span class="built_in">LoadServiceHandler</span>(<span class="string">&quot;libfoo_service.z.so&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (stub-&gt;dlHandler == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: stub-&gt;dlHanlder is null&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">delete</span> stub;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serviceConstructFunc = (SERVICE_CONSTRUCT_FUNC)<span class="built_in">dlsym</span>(stub-&gt;dlHandler, <span class="string">&quot;FooServiceConstruct&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (serviceConstructFunc == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: dlsym failed %&#123;public&#125;s&quot;</span>, __func__, <span class="built_in">dlerror</span>());</span><br><span class="line">        <span class="built_in">dlclose</span>(stub-&gt;dlHandler);</span><br><span class="line">        <span class="keyword">delete</span> stub;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stub-&gt;service = <span class="built_in">serviceConstructFunc</span>();  <span class="comment">// 获取接口实现类</span></span><br><span class="line">    <span class="keyword">if</span> (stub-&gt;service == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: get service failed %&#123;public&#125;s&quot;</span>, __func__, <span class="built_in">dlerror</span>());</span><br><span class="line">        <span class="built_in">dlclose</span>(stub-&gt;dlHandler);</span><br><span class="line">        <span class="keyword">delete</span> stub;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;<span class="type">void</span> *&gt;(stub);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 桩类实例释放</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooStubRelease</span><span class="params">(<span class="type">void</span> *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FooStub *stub = <span class="built_in">reinterpret_cast</span>&lt;FooStub *&gt;(obj);</span><br><span class="line">    <span class="keyword">if</span> (stub == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SERVICE_RELEASE_FUNC serviceReleaseFunc = (SERVICE_RELEASE_FUNC)<span class="built_in">dlsym</span>(stub-&gt;dlHandler, <span class="string">&quot;SampleServiceRelease&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (serviceReleaseFunc == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: dlsym failed %&#123;public&#125;s&quot;</span>, __func__, <span class="built_in">dlerror</span>());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">serviceReleaseFunc</span>(stub-&gt;service);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">dlclose</span>(stub-&gt;dlHandler);</span><br><span class="line">    <span class="keyword">delete</span> stub;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 消息入口</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooServiceOnRemoteRequest</span><span class="params">(<span class="type">void</span> *stub, <span class="type">int</span> cmdId, <span class="keyword">struct</span> HdfSBuf *data, <span class="keyword">struct</span> HdfSBuf *reply)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line">    FooStub *fooStub = <span class="built_in">reinterpret_cast</span>&lt;FooStub *&gt;(stub);</span><br><span class="line">    OHOS::MessageParcel *dataParcel = <span class="literal">nullptr</span>;</span><br><span class="line">    OHOS::MessageParcel *replyParcel = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)<span class="built_in">SbufToParcel</span>(reply, &amp;replyParcel);  <span class="comment">// 将C的buf转为c++的buf</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">SbufToParcel</span>(data, &amp;dataParcel) != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s:invalid data sbuf object to dispatch&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_ERR_INVALID_PARAM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    OHOS::MessageOption option;</span><br><span class="line">    <span class="keyword">return</span> fooStub-&gt;<span class="built_in">FooStubOnRemoteRequest</span>(cmdId, *dataParcel, *replyParcel, option);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>foo_service.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooService</span> : <span class="keyword">public</span> IFoo &#123;  <span class="comment">//继承接口类，并重写接口</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooService</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span> <span class="keyword">override</span></span>;  <span class="comment">//接口实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line">foo::<span class="function">v1_0::IFoo *<span class="title">FooServiceConstruct</span><span class="params">()</span></span>;  <span class="comment">// 获取service实例</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooServiceRelease</span><span class="params">(foo::v1_0::IFoo *obj)</span></span>; <span class="comment">// 释放service实例</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> __cplusplus</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __cplusplus */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOSERVICE_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_service.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口实现</span></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooService::Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line">foo::<span class="function">v1_0::IFoo *<span class="title">FooServiceConstruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> foo::v1_0::FooService;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FooService</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooServiceRelease</span><span class="params">(foo::v1_0::IFoo *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><h4 id="回调功能的IDL"><a href="#回调功能的IDL" class="headerlink" title="回调功能的IDL"></a>回调功能的IDL</h4><p>回调功能的IDL与普通接口定义的IDL不同点在于：</p>
<ul>
<li>需标识接口属性为callback。</li>
<li>生成文件中无driver文件。</li>
<li>callback对象可作为参数进行传递。</li>
</ul>
<p>提供以下IDL，例如IFooCallback.idl：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">[callback] interface IFooCallback &#123;</span><br><span class="line">    PushData([in] String message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./out</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── foo_callback_proxy.cpp</span><br><span class="line">        ├── foo_callback_proxy.h</span><br><span class="line">        ├── foo_callback_service.cpp</span><br><span class="line">        ├── foo_callback_service.h</span><br><span class="line">        ├── foo_callback_stub.cpp</span><br><span class="line">        ├── foo_callback_stub.h</span><br><span class="line">        └── ifoo_callback.h</span><br></pre></td></tr></table></figure>

<p>ifoo_callback.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_IFOOCALLBACK_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_IFOOCALLBACK_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iremote_broker.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> &#123;</span><br><span class="line">    CMD_PUSH_DATA,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IFooCallback</span> : <span class="keyword">public</span> IRemoteBroker &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">DECLARE_INTERFACE_DESCRIPTOR</span>(<span class="string">u&quot;foo.v1_0.IFooCallback&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">IFooCallback</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">int32_t</span> <span class="title">PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span> </span>= <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_IFOOCALLBACK_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_callback_proxy.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOCALLBACKPROXY_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOCALLBACKPROXY_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo_callback.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iremote_proxy.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooCallbackProxy</span> : <span class="keyword">public</span> IRemoteProxy&lt;IFooCallback&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">FooCallbackProxy</span><span class="params">(<span class="type">const</span> sptr&lt;IRemoteObject&gt;&amp; remote)</span> : IRemoteProxy&lt;IFooCallback&gt;(remote) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooCallbackProxy</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span> <span class="keyword">override</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">static</span> <span class="keyword">inline</span> BrokerDelegator&lt;FooCallbackProxy&gt; delegator_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOCALLBACKPROXY_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_callback_proxy.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_proxy.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_option.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_parcel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackProxy::PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    MessageParcel data_;</span><br><span class="line">    MessageParcel reply_;</span><br><span class="line">    <span class="function">MessageOption <span class="title">option_</span><span class="params">(MessageOption::TF_SYNC)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data_.<span class="built_in">WriteString</span>(message)) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write message failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> HDF_ERR_INVALID_PARAM;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> ec = <span class="built_in">Remote</span>()-&gt;<span class="built_in">SendRequest</span>(CMD_PUSH_DATA, data_, reply_, option_);</span><br><span class="line">    <span class="keyword">if</span> (ec != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s failed, error code is %&#123;public&#125;d&quot;</span>, __func__, ec);</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure>

<p>foo_callback_stub.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOCALLBACKSTUB_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOCALLBACKSTUB_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iremote_stub.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_option.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_parcel.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo_callback.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooCallbackStub</span> : <span class="keyword">public</span> IRemoteStub&lt;IFooCallback&gt; &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooCallbackStub</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">OnRemoteRequest</span><span class="params">(<span class="type">uint32_t</span> code, MessageParcel &amp;data, MessageParcel &amp;reply,</span></span></span><br><span class="line"><span class="params"><span class="function">        MessageOption &amp;option)</span> <span class="keyword">override</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackStubPushData</span><span class="params">(MessageParcel&amp; data_, MessageParcel&amp; reply_, MessageOption&amp; option_)</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOCALLBACKSTUB_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_callback_stub.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_stub.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackStub::OnRemoteRequest</span><span class="params">(<span class="type">uint32_t</span> code,</span></span></span><br><span class="line"><span class="params"><span class="function">    MessageParcel&amp; data, MessageParcel&amp; reply, MessageOption&amp; option)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> CMD_PUSH_DATA:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">FooCallbackStubPushData</span>(data, reply, option);</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: not support cmd %&#123;public&#125;d&quot;</span>, __func__, code);</span><br><span class="line">            <span class="keyword">return</span> IPCObjectStub::<span class="built_in">OnRemoteRequest</span>(code, data, reply, option);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackStub::FooCallbackStubPushData</span><span class="params">(MessageParcel&amp; data_, MessageParcel&amp; reply_, MessageOption&amp; option_)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::string message = data_.<span class="built_in">ReadString</span>();</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> ec = <span class="built_in">PushData</span>(message);</span><br><span class="line">    <span class="keyword">if</span> (ec != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s failed, error code is %d&quot;</span>, __func__, ec);</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure>

<p>foo_callback_service.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_FOOCALLBACKSERVICE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_FOOCALLBACKSERVICE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_stub.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooCallbackService</span> : <span class="keyword">public</span> FooCallbackStub &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">FooCallbackService</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">int32_t</span> <span class="title">PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_FOOCALLBACKSERVICE_H</span></span></span><br></pre></td></tr></table></figure>

<p>foo_callback_service.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackService::PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure>


</li>
<li><h4 id="自定义类型的IDL"><a href="#自定义类型的IDL" class="headerlink" title="自定义类型的IDL"></a>自定义类型的IDL</h4><p>自定义类型的IDL用于struct、union、enum的定义，以及提供struct结构体的序列化及反序列化接口。</p>
<p>提供以下IDL，例如MyTypes.idl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">enum FooType &#123;</span><br><span class="line">    FOO_TYPE_ONE = 1,</span><br><span class="line">    FOO_TYPE_TWO,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct FooInfo &#123;</span><br><span class="line">    unsigned int id_;</span><br><span class="line">    String name_;</span><br><span class="line">    enum FooType type_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>生成C++代码如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tree</span> ./out</span><br><span class="line">./out</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── my_types.cpp</span><br><span class="line">        └── my_types.h</span><br></pre></td></tr></table></figure>

<p>my_types.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> FOO_V1_0_MYTYPES_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FOO_V1_0_MYTYPES_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;message_parcel.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">FooType</span> &#123;</span><br><span class="line">    FOO_TYPE_ONE = <span class="number">1</span>,</span><br><span class="line">    FOO_TYPE_TWO,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">FooInfo</span> &#123;</span><br><span class="line">    <span class="type">uint32_t</span> id_;</span><br><span class="line">    std::string name_;</span><br><span class="line">    FooType type_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FooInfoBlockMarshalling</span><span class="params">(OHOS::MessageParcel &amp;data, <span class="type">const</span> FooInfo&amp; dataBlock)</span></span>;  <span class="comment">//序列化接口</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FooInfoBlockUnmarshalling</span><span class="params">(OHOS::MessageParcel &amp;data, FooInfo&amp; dataBlock)</span></span>;  <span class="comment">// 反序列化接口</span></span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">// FOO_V1_0_MYTYPES_H</span></span></span><br></pre></td></tr></table></figure>

<p>my_types.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;my_types.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;securec.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FooInfoBlockMarshalling</span><span class="params">(OHOS::MessageParcel&amp; data, <span class="type">const</span> FooInfo&amp; dataBlock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!data.<span class="built_in">WriteUint32</span>(dataBlock.id_)) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write dataBlock.id_ failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data.<span class="built_in">WriteString</span>(dataBlock.name_)) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write dataBlock.name_ failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!data.<span class="built_in">WriteUint32</span>((<span class="type">uint32_t</span>)dataBlock.type_)) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: write dataBlock.type_ failed!&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">FooInfoBlockUnmarshalling</span><span class="params">(OHOS::MessageParcel&amp; data, FooInfo&amp; dataBlock)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    dataBlock.id_ = data.<span class="built_in">ReadUint32</span>();</span><br><span class="line">    dataBlock.name_ = data.<span class="built_in">ReadString</span>();</span><br><span class="line">    dataBlock.type_ = (FooType)data.<span class="built_in">ReadUint32</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="开发实例："><a href="#开发实例：" class="headerlink" title="开发实例："></a>开发实例：</h3><ul>
<li><p>编写IDL：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tree</span> ./foo</span><br><span class="line">./foo/</span><br><span class="line">└── v1_0</span><br><span class="line">    ├── IFooCallback.idl</span><br><span class="line">    ├── IFoo.idl</span><br><span class="line">    └── MyTypes.idl</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</li>
<li><p>生成C++代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$tree</span> ./out</span><br><span class="line">./out</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── foo_callback_proxy.cpp</span><br><span class="line">        ├── foo_callback_proxy.h</span><br><span class="line">        ├── foo_callback_service.cpp</span><br><span class="line">        ├── foo_callback_service.h</span><br><span class="line">        ├── foo_callback_stub.cpp</span><br><span class="line">        ├── foo_callback_stub.h</span><br><span class="line">        ├── foo_driver.cpp</span><br><span class="line">        ├── foo_proxy.cpp</span><br><span class="line">        ├── foo_proxy.h</span><br><span class="line">        ├── foo_service.cpp</span><br><span class="line">        ├── foo_service.h</span><br><span class="line">        ├── foo_stub.cpp</span><br><span class="line">        ├── foo_stub.h</span><br><span class="line">        ├── ifoo_callback.h</span><br><span class="line">        ├── ifoo.h</span><br><span class="line">        ├── my_types.cpp</span><br><span class="line">        └── my_types.h</span><br></pre></td></tr></table></figure>
</li>
<li><p>提供测试用例，用于展示调用客户端接口：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osal_mem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;securec.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_service.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> testing::ext;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDF_LOG_TAG foo_test</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> sptr&lt;IFoo&gt; g_client = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> sptr&lt;IFooCallback&gt; g_callback = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooTest</span> : <span class="keyword">public</span> testing::Test &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">SetUpTestCase</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TearDownTestCase</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetUp</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">TearDown</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooTest::SetUpTestCase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="comment">// 获取客户端实例</span></span><br><span class="line">    g_client = IFoo::<span class="built_in">Get</span>();</span><br><span class="line">    <span class="keyword">if</span> (g_client == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FooTest: get g_client failed.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取callback实例</span></span><br><span class="line">    g_callback = <span class="keyword">new</span> <span class="built_in">FooCallbackService</span>();</span><br><span class="line">    <span class="keyword">if</span> (g_callback == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FooTest: get g_callback failed.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_001, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    std::string sendMsg = <span class="string">&quot;client str test&quot;</span>;</span><br><span class="line">    std::string recvMsg;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">Ping</span>(sendMsg, recvMsg);  <span class="comment">// 调用Ping接口</span></span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">EXPECT_EQ</span>(sendMsg, recvMsg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_002, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    FooInfo info;</span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">GetData</span>(info);</span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;info&#123;%d, %s, %d&#125;\n&quot;</span>, info.id_, info.name_.<span class="built_in">c_str</span>(), info.type_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_003, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">SendCallbackObj</span>(g_callback);  <span class="comment">//发送callback对象，server端拿到callback对象后即可向client主动发送数据。</span></span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>foo_service.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooService::Ping</span><span class="params">(<span class="type">const</span> std::string&amp; sendMsg, std::string&amp; recvMsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    recvMsg = sendMsg;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooService::GetData</span><span class="params">(FooInfo&amp; info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    info.id_ = <span class="number">1</span>;</span><br><span class="line">    info.name_ = <span class="string">&quot;info&quot;</span>;</span><br><span class="line">    info.type_ = FooType::FOO_TYPE_ONE;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooService::SendCallbackObj</span><span class="params">(<span class="type">const</span> sptr&lt;IFooCallback&gt;&amp; cbObj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int32_t</span> ec = cbObj-&gt;<span class="built_in">PushData</span>(<span class="string">&quot;hello world&quot;</span>);  <span class="comment">//service实现端调用callback对象的接口</span></span><br><span class="line">    <span class="keyword">if</span> (ec != HDF_SUCCESS) &#123;</span><br><span class="line">        <span class="built_in">HDF_LOGE</span>(<span class="string">&quot;%&#123;public&#125;s: PushData failed&quot;</span>, __func__);</span><br><span class="line">        <span class="keyword">return</span> ec;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br><span class="line"></span><br><span class="line">foo::<span class="function">v1_0::IFoo *<span class="title">FooServiceConstruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">using</span> foo::v1_0::FooService;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">FooService</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooServiceRelease</span><span class="params">(foo::v1_0::IFoo *obj)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>foo_callback_service.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_service.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_base.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> foo &#123;</span><br><span class="line"><span class="keyword">namespace</span> v1_0 &#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int32_t</span> <span class="title">FooCallbackService::PushData</span><span class="params">(<span class="type">const</span> std::string&amp; message)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;callback service receive message:&quot;</span> &lt;&lt; message &lt;&lt; std::endl;  <span class="comment">//客户端一侧的callback service实现端接收到消息</span></span><br><span class="line">    <span class="keyword">return</span> HDF_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125; <span class="comment">// v1_0</span></span><br><span class="line">&#125; <span class="comment">// foo</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="HDI集成"><a href="#HDI集成" class="headerlink" title="HDI集成"></a>HDI集成</h2><p>hdi已集成OpenHarmonyOs编译系统中，目前仅支持L2用户态驱动，开发者手动编写接口描述文件(idl)、添加驱动服务实现代码、编写BUILD.gn即可实现驱动服务与客户端的.so生成。以下为示例：</p>
<ul>
<li><p>编写接口描述(idl)文件及BUILD.gn。</p>
<p>&#x2F;&#x2F;driver&#x2F;interface&#x2F;foo&#x2F;v1_0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">OpenHarmonyOs/drivers$ tree ./interface/</span><br><span class="line">./interface/</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── BUILD.gn</span><br><span class="line">        ├── IFooCallback.idl</span><br><span class="line">        ├── IFoo.idl</span><br><span class="line">        └── MyTypes.idl</span><br></pre></td></tr></table></figure>



<p>idl文件如下：</p>
<p>IFoo.idl（接口idl，此文件定义了hdi调用接口）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">import foo.v1_0.IFooCallback;</span><br><span class="line">import foo.v1_0.MyTypes;</span><br><span class="line"></span><br><span class="line">interface IFoo &#123;</span><br><span class="line">    Ping([in] String sendMsg, [out] String recvMsg);</span><br><span class="line">    GetData([out] struct FooInfo info);</span><br><span class="line">    SendCallbackObj([in] IFooCallback cbObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>IFooCallback.idl（用于回调的idl，此文件定义了回调接口）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">[callback] interface IFooCallback &#123;</span><br><span class="line">    PushData([in] String message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>MyTypes.idl（自定义类型idl）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">package foo.v1_0;</span><br><span class="line"></span><br><span class="line">enum FooType &#123;</span><br><span class="line">    FOO_TYPE_ONE = 1,</span><br><span class="line">    FOO_TYPE_TWO,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct FooInfo &#123;</span><br><span class="line">    unsigned int id_;</span><br><span class="line">    String name_;</span><br><span class="line">    enum FooType type_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>BUILD.gn（将idl生成对应代码，并编译成so）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//drivers/adapter/uhdf2/hdi.gni&quot;</span>)  <span class="comment"># 编译idl必须要导入的模板</span></span><br><span class="line"></span><br><span class="line">hdi(<span class="string">&quot;foo&quot;</span>) &#123;                               <span class="comment"># 目标名称，会生成两个so，分别对应libfoo_proxy.z.so 和 libfoo_stub.z.so</span></span><br><span class="line">  package = <span class="string">&quot;foo.v1_0&quot;</span>                     <span class="comment"># 包名，必须与idl路径匹配</span></span><br><span class="line"></span><br><span class="line">  module_name = <span class="string">&quot;foo&quot;</span>                      <span class="comment"># module_name控制dirver文件中驱动描述符(struct HdfDriverEntry)的moduleName</span></span><br><span class="line"></span><br><span class="line">  sources = [                              <span class="comment"># 参与编译的idl文件</span></span><br><span class="line">    <span class="string">&quot;IFoo.idl&quot;</span>,                            <span class="comment"># 接口idl</span></span><br><span class="line">    <span class="string">&quot;IFooCallback.idl&quot;</span>,                    <span class="comment"># 用于回调的idl</span></span><br><span class="line">    <span class="string">&quot;MyTypes.idl&quot;</span>,                         <span class="comment"># 自定义类型idl</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  language = <span class="string">&quot;cpp&quot;</span>                         <span class="comment"># 控制idl生成c或c++代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此BUILD.gn中包含两个生成目标：libfoo_proxy.z.so，libfoo_stub.z.so</p>
</li>
<li><p>提供driver、service实现，回调service实现代码。</p>
<p>&#x2F;&#x2F;drivers&#x2F;peripheral&#x2F;foo&#x2F;v1_0</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OpenHarmonyOs/drivers/peripheral$ tree ./foo</span><br><span class="line">./foo</span><br><span class="line">└── v1_0</span><br><span class="line">    ├── BUILD.gn                      <span class="comment"># 编译配置</span></span><br><span class="line">    ├── foo_callback_service.cpp      <span class="comment"># 回调service实现</span></span><br><span class="line">    ├── foo_callback_service.h</span><br><span class="line">    ├── foo_driver.cpp                <span class="comment"># 驱动入口</span></span><br><span class="line">    ├── foo_service.cpp               <span class="comment"># 接口service实现</span></span><br><span class="line">    └── foo_service.h</span><br></pre></td></tr></table></figure>

<p>BUILD.gn</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//build/ohos.gni&quot;</span>)</span><br><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//drivers/adapter/uhdf2/uhdf.gni&quot;</span>)</span><br><span class="line"></span><br><span class="line">group(<span class="string">&quot;foo_impl&quot;</span>) &#123;</span><br><span class="line">  deps = [</span><br><span class="line">    <span class="string">&quot;:libfoo_driver&quot;</span>,</span><br><span class="line">    <span class="string">&quot;:libfoo_service&quot;</span>,</span><br><span class="line">    <span class="string">&quot;:libfoo_callback_service&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ohos_shared_library(<span class="string">&quot;libfoo_driver&quot;</span>) &#123;</span><br><span class="line">  sources = [ <span class="string">&quot;foo_driver.cpp&quot;</span> ]</span><br><span class="line">  deps = [</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/utils:libhdf_utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/interface/foo/v1_0:libfoo_stub&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_standard_system) &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hiviewdfx_hilog_native:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hilog:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># install_images = [ &quot;vendor&quot; ]</span></span><br><span class="line">  subsystem_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">  part_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ohos_shared_library(<span class="string">&quot;libfoo_service&quot;</span>) &#123;</span><br><span class="line"></span><br><span class="line">  sources = [</span><br><span class="line">    <span class="string">&quot;foo_service.cpp&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  deps = [</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/host:libhdf_host&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/ipc:libhdf_ipc_adapter&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/utils:libhdf_utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//utils/native/base:utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/interface/foo/v1_0:libfoo_stub&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_standard_system) &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hiviewdfx_hilog_native:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hilog:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># install_images = [ &quot;vendor&quot; ]</span></span><br><span class="line">  subsystem_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">  part_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ohos_shared_library(<span class="string">&quot;libfoo_callback_service&quot;</span>) &#123;</span><br><span class="line">  sources = [</span><br><span class="line">    <span class="string">&quot;foo_callback_service.cpp&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  deps = [</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/host:libhdf_host&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/ipc:libhdf_ipc_adapter&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/utils:libhdf_utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//utils/native/base:utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/interface/foo/v1_0:libfoo_proxy&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_standard_system) &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hiviewdfx_hilog_native:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hilog:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment"># install_images = [ &quot;vendor&quot; ]</span></span><br><span class="line">  subsystem_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">  part_name = <span class="string">&quot;hdf&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此BUILD.gn生成libfoo_driver.z.so，libfoo_service.z.so，libfoo_callback_service.z.so。</p>
</li>
<li><p>参与编译</p>
<p>&#x2F;&#x2F;drivers&#x2F;adapter&#x2F;uhdf2&#x2F;ohos.build</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;subsystem&quot;</span>: <span class="string">&quot;hdf&quot;</span>,</span><br><span class="line">  <span class="string">&quot;parts&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;hdf&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;module_list&quot;</span>: [</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment"># foo组，包含libfoo_proxy.z.so 与libfoo_stub.z.so两个目标</span></span><br><span class="line">        <span class="string">&quot;//drivers/interface/foo/v1_0:foo&quot;</span>,</span><br><span class="line"></span><br><span class="line">        <span class="comment"># foo_impl组，包含libfoo_driver.z.so,libfoo_service.z.so以及libfoo_callback_service.z.so三个目标</span></span><br><span class="line">        <span class="string">&quot;//drivers/peripheral/foo/v1_0:foo_impl&quot;</span></span><br><span class="line">      ],</span><br><span class="line">      <span class="string">&quot;test_list&quot;</span>: [</span><br><span class="line">        ...</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>代码详解</p>
<p>以上的idl文件生成的c++代码文件存放路径为：</p>
<p>&#x2F;&#x2F;out&#x2F;hi3516dv300&#x2F;gen&#x2F;drivers&#x2F;interface&#x2F;foo&#x2F;v1_0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">OpenHarmonyOs/out/hi3516dv300/gen/drivers/interface$ tree</span><br><span class="line">.</span><br><span class="line">└── foo</span><br><span class="line">    └── v1_0</span><br><span class="line">        ├── foo_callback_proxy.cpp</span><br><span class="line">        ├── foo_callback_proxy.h</span><br><span class="line">        ├── foo_callback_service.cpp</span><br><span class="line">        ├── foo_callback_service.h</span><br><span class="line">        ├── foo_callback_stub.cpp</span><br><span class="line">        ├── foo_callback_stub.h</span><br><span class="line">        ├── foo_driver.cpp</span><br><span class="line">        ├── foo_proxy.cpp</span><br><span class="line">        ├── foo_proxy.h</span><br><span class="line">        ├── foo_service.cpp</span><br><span class="line">        ├── foo_service.h</span><br><span class="line">        ├── foo_stub.cpp</span><br><span class="line">        ├── foo_stub.h</span><br><span class="line">        ├── ifoo_callback.h</span><br><span class="line">        ├── ifoo.h</span><br><span class="line">        ├── my_types.cpp</span><br><span class="line">        └── my_types.h</span><br></pre></td></tr></table></figure>
</li>
<li><p>hcs配置</p>
<p>&#x2F;&#x2F;vendor&#x2F;hisilicon&#x2F;Hi3516DV300&#x2F;hdf_config&#x2F;uhdf&#x2F;device_info.hcs</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">foo :: host &#123;</span><br><span class="line">    hostName = <span class="string">&quot;foo_host&quot;</span>;                       <span class="comment"># 服务进程名</span></span><br><span class="line">    priority = <span class="number">50</span>;</span><br><span class="line">    foo_device :: device &#123;</span><br><span class="line">        device0 :: deviceNode &#123;</span><br><span class="line">            policy = <span class="number">2</span>;</span><br><span class="line">            priority = <span class="number">100</span>;</span><br><span class="line">            moduleName = <span class="string">&quot;libfoo_driver.z.so&quot;</span>;   <span class="comment"># L2用户态驱动，moduleName为其依赖的so文件</span></span><br><span class="line">            serviceName = <span class="string">&quot;foo_service&quot;</span>;         <span class="comment"># 驱动服务名称，默认名称可在IFoo::Get()接口中查看，亦可任意名称</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试用例</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;thread&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;gtest/gtest.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;hdf_log.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;osal_mem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;securec.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ifoo.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;foo_callback_service.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> OHOS;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> testing::ext;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> foo::v1_0;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HDF_LOG_TAG foo_test</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> sptr&lt;IFoo&gt; g_client = <span class="literal">nullptr</span>;</span><br><span class="line"><span class="type">static</span> sptr&lt;IFooCallback&gt; g_callback = <span class="literal">nullptr</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FooTest</span> : <span class="keyword">public</span> testing::Test &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">SetUpTestCase</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">TearDownTestCase</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">SetUp</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">TearDown</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">FooTest::SetUpTestCase</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    g_client = IFoo::<span class="built_in">Get</span>();</span><br><span class="line">    <span class="keyword">if</span> (g_client == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FooTest: get g_client failed.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    g_callback = <span class="keyword">new</span> <span class="built_in">FooCallbackService</span>();</span><br><span class="line">    <span class="keyword">if</span> (g_callback == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;FooTest: get g_callback failed.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_001, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    std::string sendMsg = <span class="string">&quot;client str test&quot;</span>;</span><br><span class="line">    std::string recvMsg;</span><br><span class="line"></span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">Ping</span>(sendMsg, recvMsg);</span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">EXPECT_EQ</span>(sendMsg, recvMsg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_002, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    FooInfo info;</span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">GetData</span>(info);</span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;info&#123;%d, %s, %d&#125;\n&quot;</span>, info.id_, info.name_.<span class="built_in">c_str</span>(), info.type_);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">HWTEST_F</span>(FooTest, FooTest_003, TestSize.Level1)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int32_t</span> ec = g_client-&gt;<span class="built_in">SendCallbackObj</span>(g_callback);</span><br><span class="line">    <span class="built_in">ASSERT_EQ</span>(ec, HDF_SUCCESS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BUILD.gn</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//build/test.gni&quot;</span>)</span><br><span class="line"><span class="keyword">import</span>(<span class="string">&quot;//drivers/adapter/uhdf2/uhdf.gni&quot;</span>)</span><br><span class="line"></span><br><span class="line">module_output_path = <span class="string">&quot;hdf/foo&quot;</span></span><br><span class="line"></span><br><span class="line">ohos_unittest(<span class="string">&quot;foo_test&quot;</span>) &#123;</span><br><span class="line">  module_out_path = module_output_path</span><br><span class="line">  include_dirs = [</span><br><span class="line">    <span class="string">&quot;//drivers/peripheral/foo/v1_0&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line">  sources = [ <span class="string">&quot;foo_test.cpp&quot;</span> ]</span><br><span class="line"></span><br><span class="line">  cflags = [</span><br><span class="line">    <span class="string">&quot;-Wall&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-Wextra&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-Werror&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-fsigned-char&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-fno-common&quot;</span>,</span><br><span class="line">    <span class="string">&quot;-fno-strict-aliasing&quot;</span>,</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  deps = [</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/utils:libhdf_utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/adapter/uhdf2/hdi:libhdi&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//third_party/googletest:gmock_main&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//third_party/googletest:gtest_main&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//utils/native/base:utils&quot;</span>,</span><br><span class="line">    <span class="string">&quot;//drivers/interface/foo/v1_0:libfoo_proxy&quot;</span>,               <span class="comment"># 需依赖libfoo_proxy</span></span><br><span class="line">    <span class="string">&quot;//drivers/peripheral/foo/v1_0:libfoo_callback_service&quot;</span>,   <span class="comment"># 需依赖libfoo_callback_service</span></span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (is_standard_system) &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hiviewdfx_hilog_native:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    external_deps = [</span><br><span class="line">      <span class="string">&quot;hilog:libhilog&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ipc:ipc_core&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">group(<span class="string">&quot;foo_client_test&quot;</span>) &#123;</span><br><span class="line">  testonly = true</span><br><span class="line">  deps = [ <span class="string">&quot;:foo_test&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>代码详解</p>
<p>idl文件导入关系图：</p>
<p><img data-src="/.%5Cpicture%5Cidl%E5%AF%BC%E5%85%A5%E7%BB%93%E6%9E%84%E5%9B%BE.png"></p>
<p>以下为代码源文件对应的so:</p>
<p><img data-src="/.%5Cpicture%5C%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84%E5%8F%8A%E7%94%9F%E6%88%90so.png"></p>
<p>idl文件通过集成编译固定生成libfoo_proxy.z.so和libfoo_stub.z.so。</p>
<p>由hdi-gen工具生成的foo_driver.cpp、foo_service.h、foo_service.cpp、foo_callback_service.h、foo_callback_service.cpp不会参与编译，仅供开发者参考，开发者可手动编写所需的源文件并编译为libfoo_driver.so、libfoo_service.z.so、libfoo_callback_service.z.so。</p>
<p>.so编译依赖</p>
<p><img data-src="/.%5Cpicture%5Cso%E6%96%87%E4%BB%B6%E7%BC%96%E8%AF%91%E4%BE%9D%E8%B5%96.png"></p>
</li>
</ul>
<p>其中服务端包含三个.so，libfoo_stub.z.so通过dlopen方式在运行时连接libfoo_service.z.so，开发者需保证libfoo_service.z.so命名的准确性。</p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-10-20 12:33:31" itemprop="dateModified" datetime="2024-10-20T12:33:31+08:00">2024-10-20</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="迩彧 WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="迩彧 Alipay">
        <p>Alipay</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>迩彧 <i class="ic i-at"><em>@</em></i>迩彧博客
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="https://muxiaoximuxiaoxi.github.io/2024/04/28/HDI-GEN%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AF%BC/" title="HDI-GEN使用指导">https://muxiaoximuxiaoxi.github.io/2024/04/28/HDI-GEN使用指导/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/04/28/JAVA%20native%E5%85%B3%E9%94%AE%E5%AD%97/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giciuja1j1j20zk0m8kjl.jpg" title="JNI">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> _tv子系统</span>
  <h3>JNI</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/04/28/GN%20%E7%BC%96%E8%AF%91/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclhfehz7j20zk0m8u0x.jpg" title="GN编译">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> _tv子系统</span>
  <h3>GN编译</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#HDI-GEN%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">HDI-GEN简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IDL%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">IDL接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IDL%E7%AE%80%E4%BB%8B"><span class="toc-number">2.1.</span> <span class="toc-text">IDL简介</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDL%E6%9E%84%E6%88%90"><span class="toc-number">2.2.</span> <span class="toc-text">IDL构成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IDL%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.</span> <span class="toc-text">IDL数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.1.</span> <span class="toc-text">基本数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.2.</span> <span class="toc-text">自定义类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Sequenceable%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.3.</span> <span class="toc-text">Sequenceable数据类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.4.</span> <span class="toc-text">数组类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.5.</span> <span class="toc-text">容器类型</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#callback%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.3.0.6.</span> <span class="toc-text">callback数据类型</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HDI-GEN%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">HDI-GEN使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%BA%90%E7%A0%81%E8%8E%B7%E5%8F%96"><span class="toc-number">3.1.</span> <span class="toc-text">源码获取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E7%BC%96%E8%AF%91"><span class="toc-number">3.2.</span> <span class="toc-text">工具编译</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E4%BD%BF%E7%94%A8"><span class="toc-number">3.3.</span> <span class="toc-text">工具使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9AIDL%E6%96%87%E4%BB%B6%E7%94%9F%E6%88%90"><span class="toc-number">3.4.</span> <span class="toc-text">多IDL文件生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E4%BB%A3%E7%A0%81"><span class="toc-number">3.5.</span> <span class="toc-text">生成代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89%E7%9A%84IDL"><span class="toc-number">3.5.1.</span> <span class="toc-text">接口定义的IDL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E5%8A%9F%E8%83%BD%E7%9A%84IDL"><span class="toc-number">3.5.2.</span> <span class="toc-text">回调功能的IDL</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%B1%BB%E5%9E%8B%E7%9A%84IDL"><span class="toc-number">3.5.3.</span> <span class="toc-text">自定义类型的IDL</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E5%AE%9E%E4%BE%8B%EF%BC%9A"><span class="toc-number">3.6.</span> <span class="toc-text">开发实例：</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HDI%E9%9B%86%E6%88%90"><span class="toc-number">4.</span> <span class="toc-text">HDI集成</span></a></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li class="active"><a href="/2024/04/28/HDI-GEN%E4%BD%BF%E7%94%A8%E6%8C%87%E5%AF%BC/" rel="bookmark" title="HDI-GEN使用指导">HDI-GEN使用指导</a></li><li><a href="/2024/04/28/OpenHarmony%20HDF%20%E9%A9%B1%E5%8A%A8%E6%A1%86%E6%9E%B6%E4%BB%8B%E7%BB%8D%E5%92%8C%E9%A9%B1%E5%8A%A8%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B%E5%88%86%E6%9E%90/" rel="bookmark" title="HDF驱动框架讲解">HDF驱动框架讲解</a></li><li><a href="/2024/04/28/rk3568%E6%B5%8B%E8%AF%95/" rel="bookmark" title="rk3568测试">rk3568测试</a></li><li><a href="/2024/04/28/ubunt%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%20OpenHarmony%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0/" rel="bookmark" title="ubunt环境搭建及 OpenHarmony代码更新">ubunt环境搭建及 OpenHarmony代码更新</a></li><li><a href="/2024/04/28/%E8%93%9D%E5%8C%BA%E4%B8%8A%E5%BA%93/" rel="bookmark" title="蓝区上库">蓝区上库</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="迩彧"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">迩彧</p>
  <div class="description" itemprop="description">与其临渊羡鱼，不如退而结网</div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">22</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/04/28/JAVA%20native%E5%85%B3%E9%94%AE%E5%AD%97/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/04/28/GN%20%E7%BC%96%E8%AF%91/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%A9%B1%E5%8A%A8%E5%AD%90%E7%B3%BB%E7%BB%9F/" title="In _驱动子系统">_驱动子系统</a>
</div>

    <span><a href="/2024/04/28/rk3568%E6%B5%8B%E8%AF%95/" title="rk3568测试">rk3568测试</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%A7%86%E8%81%94%E4%BA%91%E6%A1%8C%E9%9D%A2/" title="In _视联云桌面">_视联云桌面</a>
</div>

    <span><a href="/2024/04/28/%E6%89%93%E5%8C%85%E5%8F%91%E7%89%88/" title="打包发版">打包发版</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/tv%E5%AD%90%E7%B3%BB%E7%BB%9F/" title="In _tv子系统">_tv子系统</a>
</div>

    <span><a href="/2024/04/28/JAVA%20native%E5%85%B3%E9%94%AE%E5%AD%97/" title="JNI">JNI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%A7%86%E8%81%94%E4%BA%91%E6%A1%8C%E9%9D%A2/" title="In _视联云桌面">_视联云桌面</a>
</div>

    <span><a href="/2024/04/28/%E5%BC%80%E5%90%AFNVIDIA%20RTX%202060%E6%98%BE%E5%8D%A1%E8%99%9A%E6%8B%9F%E5%8C%96(vGPU)-PVE%207.4/" title="VGPU">VGPU</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%A9%B1%E5%8A%A8%E5%AD%90%E7%B3%BB%E7%BB%9F/" title="In _驱动子系统">_驱动子系统</a>
</div>

    <span><a href="/2024/04/28/%E8%93%9D%E5%8C%BA%E4%B8%8A%E5%BA%93/" title="蓝区上库">蓝区上库</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%A7%86%E8%81%94SDK/" title="In _视联SDK">_视联SDK</a>
</div>

    <span><a href="/2024/03/22/TVL%E6%A0%BC%E5%BC%8F/" title="TVL格式">TVL格式</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/tv%E5%AD%90%E7%B3%BB%E7%BB%9F/" title="In _tv子系统">_tv子系统</a>
</div>

    <span><a href="/2024/04/28/Android%20IPC%20%E4%B9%8B%20AIDL/" title="Android IPC 之 AIDL">Android IPC 之 AIDL</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%A9%B1%E5%8A%A8%E5%AD%90%E7%B3%BB%E7%BB%9F/" title="In _驱动子系统">_驱动子系统</a>
</div>

    <span><a href="/2024/04/28/ubunt%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E5%8F%8A%20OpenHarmony%E4%BB%A3%E7%A0%81%E6%9B%B4%E6%96%B0/" title="ubunt环境搭建及 OpenHarmony代码更新">ubunt环境搭建及 OpenHarmony代码更新</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%A7%86%E8%81%94SDk/" title="In _视联SDk">_视联SDk</a>
</div>

    <span><a href="/2024/03/28/%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91%E9%93%BE%E5%8F%8A%E5%85%B6%E4%BB%96%E7%9B%B8%E5%85%B3/" title="交叉编译链接及其他">交叉编译链接及其他</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%A7%86%E8%81%94%E6%B5%8F%E8%A7%88%E5%99%A8/" title="In _视联浏览器">_视联浏览器</a>
</div>

    <span><a href="/2024/02/23/DNS%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%8F%8Abind9%E4%BB%8B%E7%BB%8D/" title="DNS域名解析及bind9介绍">DNS域名解析及bind9介绍</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">迩彧 @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/04/28/HDI-GEN使用指导/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
